# ============================================================================
# Frontend CI — Lint, Type-check, Unit Tests & Coverage
# ============================================================================
# Triggers on push/PR to main, develop, and feature branches.
# Blocks merge when lint, type-check, or tests fail.
#
# Jobs:
#   1. lint        — ESLint
#   2. type-check  — TypeScript strict mode (tsc --noEmit)
#   3. test        — Vitest unit + component + a11y tests with coverage
#   4. build       — Next.js production build (validates SSR/SSG)
# ============================================================================

name: Frontend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig*.json'
      - 'next.config.*'
      - 'vitest.config.*'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig*.json'
      - 'next.config.*'
      - 'vitest.config.*'
      - '.github/workflows/frontend-ci.yml'

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: frontend-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  # --------------------------------------------------------------------------
  # Lint
  # --------------------------------------------------------------------------
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PKG_READ_TOKEN }}

      - name: Run ESLint
        run: pnpm lint

  # --------------------------------------------------------------------------
  # Type check
  # --------------------------------------------------------------------------
  type-check:
    name: TypeScript
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PKG_READ_TOKEN }}

      - name: Type check
        run: pnpm type-check

  # --------------------------------------------------------------------------
  # Unit / Component / A11y tests with coverage
  # --------------------------------------------------------------------------
  test:
    name: Vitest Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PKG_READ_TOKEN }}

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: coverage/
          retention-days: 14

  # --------------------------------------------------------------------------
  # Production build
  # --------------------------------------------------------------------------
  build:
    name: Next.js Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, type-check, test]

    env:
      # Minimal env vars required for Next.js build to succeed
      AUTH_SECRET: ci-build-placeholder-secret
      AUTH0_CLIENT_ID: ci-build-placeholder
      AUTH0_CLIENT_SECRET: ci-build-placeholder
      AUTH0_ISSUER: https://ci-build.auth0.com
      AUTH0_AUDIENCE: http://localhost:3001
      NEXTAUTH_URL: http://localhost:3000

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PKG_READ_TOKEN }}

      - name: Build
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: .next/
          retention-days: 7
